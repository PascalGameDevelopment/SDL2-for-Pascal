name: CI

on:
  push:
    branches: [ master, use-fptest ]
  pull_request:
    branches: [ master ]

jobs:
  macos-11-big-sur:
    # if: false (uncomment to skip job)
    runs-on: macos-11
    steps:
      - name: Install FPC
        run: |
          brew update
          brew install fpc
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Compile SDL2 unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2.pas
          verbosity: ewnh
      - name: Compile SDL2_gfx unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_gfx.pas
          verbosity: ewnh
      - name: Compile SDL2_image unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_image.pas
          verbosity: ewnh
      - name: Compile SDL2_mixer unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_mixer.pas
          verbosity: ewnh
      - name: Compile SDL2_net unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_net.pas
          verbosity: ewnh
      - name: Compile SDL2_ttf unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_ttf.pas
          verbosity: ewnh
      - name: Install SDL2 library
        run: brew install sdl2
      - name: Get SDL2 library version and path(s)
        run: |
          sdl2-config --version
          sdl2-config --libs
      - name: Compile SDL2-for-Pascal Test Framework (fptest) and Test Cases
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: tests/sdl2forpascaltests.pas
          flags: Fl/usr/local/lib Fuunits Futests/fptest/src Futests/fptest/3rdparty/epiktimer
          verbosity: ewnh
      - name: Run SDL2-for-Pascal Tests
        run: |
          ./tests/sdl2forpascaltests
  ubuntu-20-04:
    # if: false (uncomment to skip job)
    runs-on: ubuntu-20.04
    steps:
      - name: Install FPC
        run: |
           export DEBIAN_FRONTEND=noninteractive
           sudo apt update
           sudo apt install fpc
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Compile SDL2 unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2.pas
          verbosity: ewnh
      - name: Compile SDL2_gfx unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_gfx.pas
          verbosity: ewnh
      - name: Compile SDL2_image unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_image.pas
          verbosity: ewnh
      - name: Compile SDL2_mixer unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_mixer.pas
          verbosity: ewnh
      - name: Compile SDL2_net unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_net.pas
          verbosity: ewnh
      - name: Compile SDL2_ttf unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_ttf.pas
          verbosity: ewnh
      - name: Install SDL2 library
        run: sudo apt-get install libsdl2-dev
      - name: Compile SDL2-for-Pascal Test Framework (fptest) and Test Cases
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: tests/sdl2forpascaltests.pas
          flags: Fuunits Futests/fptest/src Futests/fptest/3rdparty/epiktimer
          verbosity: ewnh
      - name: Run SDL2-for-Pascal Tests
        run: |
          ./tests/sdl2forpascaltests
  windows-2022:
    # if: false (uncomment to skip job)
    runs-on: windows-2022
    steps:
      - name: Install Lazarus
        run: |
          choco install lazarus
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Compile SDL2 unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2.pas
          verbosity: ewnh
      - name: Compile SDL2_gfx unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_gfx.pas
          verbosity: ewnh
      - name: Compile SDL2_image unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_image.pas
          verbosity: ewnh
      - name: Compile SDL2_mixer unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_mixer.pas
          verbosity: ewnh
      - name: Compile SDL2_net unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_net.pas
          verbosity: ewnh
      - name: Compile SDL2_ttf unit
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: units/sdl2_ttf.pas
          verbosity: ewnh
      - name: Copy SDL2 library file to execution folder
        run: copy tests/dll/SDL2.dll tests
      - name: Compile SDL2-for-Pascal Test Framework (fptest) and Test Cases
        uses: suve/GHActions-FPC@v0.4.0
        with:
          source: tests/sdl2forpascaltests.pas
          flags: Fuunits Futests/fptest/src Futests/fptest/3rdparty/epiktimer
          verbosity: ewnh
      - name: Run SDL2-for-Pascal Tests
        run: |
          ./tests/sdl2forpascaltests.exe
